---
/**
 * BFF Demo Page
 *
 * –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è BFF —à–∞—Ä—É —É Astro –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö.
 * –¶—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –ø–æ–∫–∞–∑—É—î —è–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∑–∞—î–º–æ–¥—ñ—è—Ç–∏ –∑ –±–µ–∫–µ–Ω–¥–æ–º —á–µ—Ä–µ–∑ BFF.
 */

import BaseLayout from "@/layouts/base/BaseLayout.astro";
import Container from "@/components/base/Container.astro";
import Card from "@/components/base/Card.astro";
import Button from "@/components/base/Button.astro";
import { fetchCollection, fetchMultipleCollections } from "@/bff/client";

// –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ BFF (SSR)
const singleCollectionResult = await fetchCollection("posts", {
  page: 1,
  limit: 5,
  sortBy: "date",
  order: "desc",
});

// –û—Ç—Ä–∏–º—É—î–º–æ –∫—ñ–ª—å–∫–∞ –∫–æ–ª–µ–∫—Ü—ñ–π –æ–¥–Ω–æ—á–∞—Å–Ω–æ (–∞–≥—Ä–µ–≥–∞—Ü—ñ—è)
const multipleCollectionsResult = await fetchMultipleCollections([
  "posts",
  "products",
]);

const posts = singleCollectionResult.success
  ? singleCollectionResult.data
  : null;
const postsError = singleCollectionResult.success
  ? null
  : singleCollectionResult.error;

const collections = multipleCollectionsResult.success
  ? multipleCollectionsResult.data
  : null;
const collectionsError = multipleCollectionsResult.success
  ? null
  : multipleCollectionsResult.error;
---

<BaseLayout
  title="BFF Demo"
  description="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è Backend for Frontend —à–∞—Ä—É"
>
  <Container>
    <div class="space-y-12 py-12">
      <!-- Header -->
      <div class="space-y-4 text-center">
        <h1 class="text-4xl font-bold">BFF Demo</h1>
        <p class="text-xl text-gray-600 dark:text-gray-400">
          –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è Backend for Frontend —à–∞—Ä—É
        </p>
      </div>

      <!-- Section 1: Single Collection -->
      <section class="space-y-6">
        <div>
          <h2 class="mb-2 text-2xl font-bold">–û—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–¥–Ω—ñ—î—ó –∫–æ–ª–µ–∫—Ü—ñ—ó</h2>
          <p class="text-gray-600 dark:text-gray-400">
            –ü—Ä–∏–∫–ª–∞–¥ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–ª–µ–∫—Ü—ñ—ó —á–µ—Ä–µ–∑ BFF –∑ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—î—é —Ç–∞ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è–º
          </p>
        </div>

        {
          postsError ? (
            <Card>
              <div class="p-4 text-red-600">
                <h3 class="mb-2 text-lg font-bold">
                  –ü–æ–º–∏–ª–∫–∞: {postsError.code}
                </h3>
                <p>{postsError.userMessage}</p>
                <p class="mt-2 text-sm text-gray-500">{postsError.message}</p>
              </div>
            </Card>
          ) : posts ? (
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-semibold">–ö–æ–ª–µ–∫—Ü—ñ—è: {posts.name}</p>
                  <p class="text-sm text-gray-600">
                    –í—Å—å–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤: {posts.totalItems}
                  </p>
                  <p class="text-sm text-gray-600">
                    –û–Ω–æ–≤–ª–µ–Ω–æ: {posts.updatedAt}
                  </p>
                </div>
                {posts.pagination && (
                  <div class="text-sm">
                    <p>
                      –°—Ç–æ—Ä—ñ–Ω–∫–∞ {posts.pagination.currentPage} –∑{" "}
                      {posts.pagination.totalPages}
                    </p>
                  </div>
                )}
              </div>

              <div class="grid gap-4 md:grid-cols-2">
                {posts.items.map((post) => (
                  <Card>
                    <div class="space-y-2">
                      <h3 class="text-lg font-bold">{post.title}</h3>
                      {post.excerpt && (
                        <p class="text-gray-600 dark:text-gray-400">
                          {post.excerpt}
                        </p>
                      )}
                      <div class="flex items-center justify-between text-sm">
                        {post.author && (
                          <span class="text-gray-500">
                            –ê–≤—Ç–æ—Ä: {post.author}
                          </span>
                        )}
                        {post.publishedDate && (
                          <span class="text-gray-500">
                            {post.publishedDate}
                          </span>
                        )}
                      </div>
                      {post.tags.length > 0 && (
                        <div class="flex flex-wrap gap-2">
                          {post.tags.map((tag) => (
                            <span class="rounded bg-blue-100 px-2 py-1 text-xs text-blue-600 dark:bg-blue-900 dark:text-blue-300">
                              {tag}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  </Card>
                ))}
              </div>
            </div>
          ) : (
            <Card>
              <p class="text-center text-gray-500">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</p>
            </Card>
          )
        }
      </section>

      <!-- Section 2: Multiple Collections (Aggregation) -->
      <section class="space-y-6">
        <div>
          <h2 class="mb-2 text-2xl font-bold">–ê–≥—Ä–µ–≥–∞—Ü—ñ—è –∫—ñ–ª—å–∫–æ—Ö –∫–æ–ª–µ–∫—Ü—ñ–π</h2>
          <p class="text-gray-600 dark:text-gray-400">
            –ü—Ä–∏–∫–ª–∞–¥ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Ö –∫–æ–ª–µ–∫—Ü—ñ–π –æ–¥–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º —á–µ—Ä–µ–∑ BFF
          </p>
        </div>

        {
          collectionsError ? (
            <Card>
              <div class="p-4 text-red-600">
                <h3 class="mb-2 text-lg font-bold">
                  –ü–æ–º–∏–ª–∫–∞: {collectionsError.code}
                </h3>
                <p>{collectionsError.userMessage}</p>
              </div>
            </Card>
          ) : collections ? (
            <div class="grid gap-6 md:grid-cols-2">
              {Object.entries(collections).map(([name, collection]) => (
                <Card>
                  <div class="space-y-4">
                    <div>
                      <h3 class="text-xl font-bold">{collection.name}</h3>
                      <p class="text-sm text-gray-600">
                        {collection.totalItems} –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
                      </p>
                    </div>
                    <ul class="space-y-2">
                      {collection.items.slice(0, 3).map((item) => (
                        <li class="border-l-2 border-blue-500 pl-3">
                          <p class="font-medium">{item.title}</p>
                          {item.publishedDate && (
                            <p class="text-xs text-gray-500">
                              {item.publishedDate}
                            </p>
                          )}
                        </li>
                      ))}
                    </ul>
                    {collection.items.length > 3 && (
                      <p class="text-sm text-gray-500">
                        —Ç–∞ —â–µ {collection.items.length - 3} –µ–ª–µ–º–µ–Ω—Ç—ñ–≤...
                      </p>
                    )}
                  </div>
                </Card>
              ))}
            </div>
          ) : null
        }
      </section>

      <!-- Section 3: Client-side Example -->
      <section class="space-y-6">
        <div>
          <h2 class="mb-2 text-2xl font-bold">–ö–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π –∑–∞–ø–∏—Ç</h2>
          <p class="text-gray-600 dark:text-gray-400">
            –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è BFF –∑ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–æ–≥–æ JavaScript
          </p>
        </div>

        <Card>
          <div class="space-y-4">
            <div id="search-section" class="space-y-3">
              <div class="flex gap-2">
                <input
                  type="text"
                  id="search-input"
                  placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç..."
                  class="flex-1 rounded-lg border px-4 py-2 dark:border-gray-700 dark:bg-gray-800"
                />
                <Button id="search-button">–ü–æ—à—É–∫</Button>
              </div>
              <div id="search-results" class="space-y-2"></div>
            </div>
          </div>
        </Card>
      </section>

      <!-- Section 4: BFF Benefits -->
      <section class="space-y-6">
        <div>
          <h2 class="mb-2 text-2xl font-bold">–ü–µ—Ä–µ–≤–∞–≥–∏ BFF</h2>
        </div>

        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          <Card>
            <div class="space-y-2">
              <h3 class="text-lg font-bold">üîÑ –ê–≥—Ä–µ–≥–∞—Ü—ñ—è</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                –û–±'—î–¥–Ω–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ –∫—ñ–ª—å–∫–æ—Ö API –≤ –æ–¥–∏–Ω –∑–∞–ø–∏—Ç
              </p>
            </div>
          </Card>

          <Card>
            <div class="space-y-2">
              <h3 class="text-lg font-bold">üîß –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –ø—ñ–¥ –ø–æ—Ç—Ä–µ–±–∏ UI (—Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è, –æ–±—á–∏—Å–ª–µ–Ω–Ω—è)
              </p>
            </div>
          </Card>

          <Card>
            <div class="space-y-2">
              <h3 class="text-lg font-bold">üîí –ë–µ–∑–ø–µ–∫–∞</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                –ü—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è API —Ç–æ–∫–µ–Ω—ñ–≤ —Ç–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
              </p>
            </div>
          </Card>

          <Card>
            <div class="space-y-2">
              <h3 class="text-lg font-bold">‚ö° –ö–µ—à—É–≤–∞–Ω–Ω—è</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ –∫–µ—à—É–≤–∞–Ω–Ω—è –Ω–∞ —Ä—ñ–≤–Ω—ñ BFF
              </p>
            </div>
          </Card>

          <Card>
            <div class="space-y-2">
              <h3 class="text-lg font-bold">üõ°Ô∏è –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                –Ñ–¥–∏–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–æ –æ–±—Ä–æ–±–∫–∏ —Ç–∞ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫
              </p>
            </div>
          </Card>

          <Card>
            <div class="space-y-2">
              <h3 class="text-lg font-bold">üîå –í—ñ–¥–≤'—è–∑–∫–∞</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                UI –Ω–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –±–µ–∫–µ–Ω–¥ API
              </p>
            </div>
          </Card>
        </div>
      </section>
    </div>
  </Container>
</BaseLayout>

<script>
  // –ö–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π –∫–æ–¥ –¥–ª—è –ø–æ—à—É–∫—É
  const searchInput = document.getElementById(
    "search-input",
  ) as HTMLInputElement;
  const searchButton = document.getElementById("search-button");
  const searchResults = document.getElementById("search-results");

  searchButton?.addEventListener("click", async () => {
    const query = searchInput?.value.trim();
    if (!query || !searchResults) return;

    searchResults.innerHTML = '<p class="text-gray-500">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>';

    try {
      const response = await fetch(
        `/api/bff/collections/search?collection=posts&q=${encodeURIComponent(query)}`,
      );
      const result = await response.json();

      if (result.success && result.data.items.length > 0) {
        searchResults.innerHTML = result.data.items
          .map(
            (item: any) => `
            <div class="p-3 border rounded-lg dark:border-gray-700">
              <p class="font-medium">${item.title}</p>
              ${item.excerpt ? `<p class="text-sm text-gray-600 dark:text-gray-400">${item.excerpt}</p>` : ""}
            </div>
          `,
          )
          .join("");
      } else if (result.success) {
        searchResults.innerHTML =
          '<p class="text-gray-500">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>';
      } else {
        searchResults.innerHTML = `<p class="text-red-600">${result.error.userMessage}</p>`;
      }
    } catch (error) {
      searchResults.innerHTML =
        '<p class="text-red-600">–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ –ø–æ—à—É–∫—É</p>';
    }
  });

  // –ü–æ—à—É–∫ –ø–æ Enter
  searchInput?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      searchButton?.click();
    }
  });
</script>
